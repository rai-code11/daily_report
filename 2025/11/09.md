## 取り組んだ課題一覧
- 

## わかったこと
### セッションIDをカートに保存する理由（Django／セッション×Cart設計）

### 目的
- セッションID（自動生成の鍵） と DBの永続データ（Cartレコード） を 1対1で結びつける。
- これにより「ブラウザ（セッション）ごとの個別カート」が実現する。

---

### 1) 取得方法
- `request.session.session_key` で 現在のセッションID を取得する。

```python
# セッションIDの確定と取得
def ensure_session_and_get_key(request):
    if not request.session.session_key:
        request.session.save()  # キー未発行ならここで確定
    return request.session.session_key
```

---

### 2) 保存する場所
- Cartモデルの `session_key` フィールド に保存する。

| モデル | フィールド | 保存例 |
|---|---|---|
| Cart | session_key (CharField) | `abc123xyzDEF456` |

```python
# 例: Cartモデルのイメージ
# from django.db import models
#
# class Cart(models.Model):
#     session_key = models.CharField(max_length=40, unique=True)
```

---

### 3) 動作の流れ（コードのイメージ）
1. ブラウザからリクエスト → DjangoがセッションIDを生成/取得  
2. `request.session.session_key` を取り出す  
3. Cartテーブル を そのIDで検索  
4. 見つからなければ `session_key` をセットして新規作成  
5. 確定した Cart に対して CartItem を作成/更新

---

### 実装を分ける：2つのビュー構成

#### 1) `AddToCartView`（商品追加・更新：POST）
| 処理ステップ | 目的 |
|---|---|
| A. セッションIDの取得 | `request.session.save()` と `request.session.session_key` で確定 |
| B. Cartレコードの確定 | `get_or_create` で 検索/作成 |
| C. CartItemの追加/更新 | `product_id` を基に数量更新 or 新規作成 |
| D. リダイレクト | カート詳細へ |

---

#### 2) `CartDetailView`（カート表示：GET）
| 処理ステップ | 目的 |
|---|---|
| A. セッションIDの取得 | `request.session.save()` と `request.session.session_key` で確定 |
| B. Cartレコードの検索 | 検索のみ（新規作成はしない） |
| C. CartItemの取得 | `select_related("product")` で製品情報も同時取得 |
| D. 合計金額の計算 | 合計数量・合計金額などの集計 |
| E. テンプレート埋め込み | 計算結果と商品リストをコンテキストに載せる |

---

## `get_or_create(..., defaults=...)` の正しい理解

### 結論
- `defaults` は「その1回の新規作成時だけ使う初期値」。  
- 検索条件（lookup）が異なれば 別レコードが作られ、その新規作成にだけ適用。  
- 「常に同じ値が全員に強制され続ける」わけではない。

```python
obj, created = Cart.objects.get_or_create(
    session_key=current_session_id,     # まずここで既存検索
    defaults={"session_key": "example"} # 見つからない時だけ適用
)

# ケース分岐の考え方
# 別ブラウザ → session_key が違う → 既存ヒットしない → 新規作成（defaultsが1回だけ反映）
# 同じブラウザ（同一セッション） → 既存が見つかる → defaults は無視（上書きしない）
```

### ルール（バリデーション的な注意）
- `defaults` に入れられるのは「そのモデルに実在するフィールド名」＝キー  
- かつ そのフィールドに有効な値（型・制約を満たす値）だけ

```python
# OK 例
cart, _ = Cart.objects.get_or_create(
    session_key=current_session_id,
    defaults={"session_key": current_session_id},
)

# NG 例（存在しないフィールド名）
# Cart.objects.get_or_create(session_key=key, defaults={"foo": "bar"})  # FieldError
```

---

## まとめ
- セッションIDをCartに保存して「セッション＝カート」の対応付けを実現。  
- 追加/更新は AddToCartView（POST）、表示は CartDetailView（GET） に分離。  
- `get_or_create` と `defaults` は「新規作成時だけ初期値を入れる」仕組み。  
- `defaults` は 実在フィールド＋妥当な値のみ を指定すること。

## 次やること
- 
- 


## 感じたこと
- 

## 学習時間
- 4.5
