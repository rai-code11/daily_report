
## 取り組んだ課題一覧  
-a  Dockerのチュートリアル

-b  クィックスタート: Compose と Rails

## わかったこと

### コンテナの停止＋削除（強制）

- 単体のコンテナを強制停止＆削除  
  ```bash
  docker rm -f <コンテナID>
  ```

- 全コンテナを一括で強制停止＆削除  
  ```bash
  docker rm -f $(docker ps -aq)
  ```

---

### Docker Hub にイメージをプッシュする手順

1. ログインする  
   ```bash
   docker login -u <ユーザー名>
   ```

2. タグをつける（ユーザー名/リポジトリ名:タグ）  
   ```bash
   docker tag <ローカルイメージ名> <ユーザー名>/<リポジトリ名>:<タグ>
   ```

3. プッシュする  
   ```bash
   docker push <ユーザー名>/<リポジトリ名>:<タグ>
   ```

4. 補足  
   - タグを省略すると `latest` が自動でつく  
   - リポジトリ名やタグが間違っていると push に失敗する

---

### push access denied の対処法

- `docker logout` → `docker login` を試してトークンを再取得する  
- リポジトリ名やタグが正しいか確認する  
- ログイン後に再度 `docker push` を試すと解決することが多い

---

### バインドマウント（開発向き）

- ホストのフォルダとコンテナのフォルダをリアルタイムで共有できる  
- ホスト側のファイル編集がすぐにコンテナに反映される  
- ホスト上の好きなパスを使える  

```bash
docker run -v $(pwd)/app:/app my-image
```

```bash
docker run --mount type=bind,source=$(pwd)/app,target=/app my-image
```

---

### ボリュームマウント（本番向き）

- Dockerが管理する専用の保存場所（ボリューム）を使う  
- コンテナを削除してもデータが残るため、永続化に向いている  
- 保存場所は Docker が自動で管理し、自分で指定できない  

```bash
docker run -v my-volume:/app/data my-image
```

```bash
docker run --mount type=volume,source=my-volume,target=/app/data my-image
```

---

### バインドマウントとボリュームマウントの違い（文章で説明）

- バインドマウントは「ホストと共有」に強く、開発用途に向いている  
- ボリュームマウントは「データの保存」に強く、本番環境に向いている  
- バインドマウントでは保存先を自分で指定できる  
- ボリュームマウントでは保存先はDockerが自動で管理する

---

### `-v` と `--mount` の使い分け

- `--mount` の方が明示的でエラーが起きにくいため、チーム開発や複雑な設定に向いている  
- `-v` はシンプルで短く、学習や個人開発に適している

---

### Docker + MySQL + Node.js アプリ連携手順

1. 仮想ネットワーク作成  
   ```bash
   docker network create todo-app
   ```

2. MySQLコンテナ起動  
   ```bash
   docker run -d \
     --network todo-app \
     --network-alias mysql \
     -v todo-mysql-data:/var/lib/mysql \
     -e MYSQL_ROOT_PASSWORD=secret \
     -e MYSQL_DATABASE=todos \
     mysql:8.0
   ```

3. MySQLに接続  
   ```bash
   docker exec -it <mysql-container-id> mysql -u root -p
   ```

4. 名前解決の確認（netshoot使用）  
   ```bash
   docker run -it --network todo-app nicolaka/netshoot
   dig mysql
   ```

5. Node.jsアプリ起動  
   ```bash
   docker run -dp 127.0.0.1:3000:3000 \
     -w /app \
     -v "$(pwd):/app" \
     --network todo-app \
     -e MYSQL_HOST=mysql \
     -e MYSQL_USER=root \
     -e MYSQL_PASSWORD=secret \
     -e MYSQL_DB=todos \
     node:18-alpine \
     sh -c "yarn install && yarn run dev"
   ```

6. ログ確認  
   ```bash
   docker logs <container-id>
   ```

7. MySQLでデータ確認  
   ```bash
   docker exec -it <mysql-container-id> mysql -p todos
   ```

---

### Docker + Rails + PostgreSQL 環境構築手順

1. ディレクトリ作成  
   ```bash
   mkdir docker_project && cd docker_project
   mkdir docker_compose_rails && cd docker_compose_rails
   ```

2. Dockerfile 作成  
   ```Dockerfile
   FROM ruby:3.3.0
   RUN apt-get update -qq && apt-get install -y nodejs postgresql-client yarn
   WORKDIR /app
   COPY Gemfile Gemfile.lock ./
   RUN bundle install
   COPY . .
   ```

3. docker-compose.yml 作成  
   ```yaml
   version: '3'
   services:
     db:
       image: postgres
       environment:
         POSTGRES_USER: postgres
         POSTGRES_PASSWORD: password

     web:
       build: .
       command: bundle exec rails s -p 3000 -b '0.0.0.0'
       volumes:
         - .:/myapp
       ports:
         - "3000:3000"
       depends_on:
         - db
       environment:
         RAILS_ENV: development
         DATABASE_URL: postgres://postgres:password@db:5432/myapp_development
   ```

4. Gemfile & Gemfile.lock 用意  
   ```ruby
   # Gemfile
   source 'https://rubygems.org'
   gem 'rails', '~> 7.1.5'
   ```

   ```bash
   touch Gemfile.lock
   ```

5. Railsアプリを初期化  
   ```bash
   docker-compose run web rails new . --force --database=postgresql
   ```

6. イメージ再ビルド  
   ```bash
   docker-compose build
   ```

7. database.yml を修正（host を `db` に）

8. DB作成  
   ```bash
   docker-compose run web bundle exec rake db:create
   ```

9. サーバー起動  
   ```bash
   docker-compose up
   ```

10. よくあるエラーと対処  
    - エラー内容：`Missing secret_key_base for 'production' environment`  
    - 原因：RAILS_ENV が production になっている  
    - 対処法：`docker-compose.yml` の環境変数に `RAILS_ENV: development` を追加する

11. 動作確認  
    - ブラウザで `http://localhost:3000` にアクセス  
    - Railsロゴが表示されれば成功

## 次やること
-a  クィックスタート: Compose と Railsの復習

-b  Docker開発環境の構築

-c　ブログ作成

## 感じたこと
-a  Rubyのバージョンによって互換性が異なりエラーが発生するので大変だった。

-b  基本的なDockerの使い方はわかってきがたまだwebアプリの開発環境を構築するまでスムーズにできないので繰り返し学習して少しずつ理解を深めていきたい。

## 学習時間
-6.25h
