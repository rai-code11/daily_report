## 取り組んだ課題一覧
- ECサイト_詳細ページ

## わかったこと
### Cloudinary で cloudinary_url() が動作しない原因と修正方法

### 原因

`cloudinary_url()` がエラーを出す理由は、**Cloudinary のグローバル設定に `cloud_name` が見つからないため**。

`django-cloudinary-storage` の設定項目である `CLOUDINARY_STORAGE = {...}` は、Django の **ストレージAPI用設定** に使われます。  
一方、`cloudinary_url()` は Cloudinary SDK が使う **配信用URL生成** 関数であり、こちらは `CLOUDINARY_URL` 環境変数または `cloudinary.config(...)` から設定を読む仕組みになっています。

そのため、SDKが参照する設定が存在しない状態で `cloudinary_url()` を呼び出すと  
`Must supply cloud_name...` というエラーが発生します。

---

### 修正方法（どちらか1つでOK）

### 方法A：環境変数で設定する（最も簡単）

`.env.local` や `docker-compose.yml` に次のように追加する。

```
CLOUDINARY_URL=cloudinary://<API_KEY>:<API_SECRET>@<CLOUD_NAME>
```

例：

```
CLOUDINARY_URL=cloudinary://1234567890:abcdefg@hfofbwa6i
```

Django は起動時にこの環境変数を読み込み、  
`cloudinary_url()` で自動的に Cloudinary の設定が使えるようになる。

---

### 動作確認

Django シェルで以下を実行して確認する。

```python
python manage.py shell
>>> import cloudinary
>>> cloudinary.config().cloud_name
'hfofbwa6i'   # None ではなくなっていればOK

>>> from cloudinary.utils import cloudinary_url
>>> cloudinary_url("media/images/afurikaookonohazuku_kd1nx9", width=450, height=300, crop="fill", secure=True)[0]
'https://res.cloudinary.com/hfofbwa6i/image/upload/c_fill,h_300,w_450/media/images/afurikaookonohazuku_kd1nx9.jpg'
```

---

### よくある原因と対処

- **Cloudinary CDN が古い画像を返している**  
  → URLに `?invalidate=true` または `version` パラメータを追加して再読み込みする。

- **ブラウザキャッシュ**  
  → ハードリロード（Cmd + Shift + R）で再読み込み。

- **HTML が古い**  
  → テンプレートキャッシュの削除、または開発サーバーの再起動。

- **テンプレート変数の指定ミス**  
  → `{{ product.list_thumb_url }}` を使っているか確認する。  
    `.image.url` を呼んでいるとリサイズが反映されない。

---

### デバッグ手順（最短で原因を切り分ける）

1. Chrome DevTools を開き、「Network」タブで該当画像をクリック。  
2. URL に `c_fill,w_450,h_300` が含まれているか確認する。  
3. 含まれていてサイズが変わらない場合 → Cloudinary 側のキャッシュが原因。  
4. 含まれていない場合 → テンプレートで `.image.url` を呼んでいる。

この確認により、**コード側の問題かキャッシュ側の問題かを確実に判断できる**。

---

### キャッシュ無効化の実装例

Cloudinary のキャッシュを強制的に無効化するために、  
`version=int(time.time())` を指定する。

```python
from cloudinary.utils import cloudinary_url
import time

class ProductList(models.Model):
    # ...

    @property
    def list_thumb_url(self):
        public_id = self.image.name
        url, _ = cloudinary_url(
            public_id,
            width=450,
            height=300,
            crop="fill",
            secure=True,
            version=int(time.time()),  # キャッシュ無効化
        )
        return url
```

---

この修正により、`cloudinary_url()` が正しく `cloud_name` を認識し、  
Cloudinary 側のキャッシュも最新の画像URLで更新されるようになる。

## 次やること
- ECサイト詳細ページ

## 感じたこと
- 

## 学習時間
- 5.85h
